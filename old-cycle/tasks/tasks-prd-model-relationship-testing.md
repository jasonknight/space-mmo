# Tasks: Model Relationship Testing

## Relevant Files

- `gamedb/thrift/py/db_models/generate_models.py` - The main model generator script that will be enhanced to generate comprehensive relationship tests.
- `gamedb/thrift/py/db_models/tests.py` - Auto-generated test file that will contain all relationship tests.
- `gamedb/thrift/py/db_models/models.py` - Generated models file with all relationship features to be tested.
- `/vagrant/tasks/prd-model-relationship-testing.md` - The PRD document outlining all testing requirements.

## Notes

- All tests will be auto-generated by `generate_models.py`
- Use seed data approach to create complete relationship graphs for testing
- Tests should validate internal mechanisms: dirty tracking, caching, cascade saves, lazy loading
- Use `py tests.py` to run all generated tests
- Target: 250+ comprehensive tests covering all relationship features
- Test suite should complete in < 30 seconds
- Individual tests should complete in < 100ms average

## Tasks

- [ ] 1.0 Create Seed Data Generation System
  - [ ] 1.1 Add `generate_seed_data_function()` helper to generate seed data setup code
  - [ ] 1.2 Implement seed data structure that creates complete relationship graph
  - [ ] 1.3 Create seed data for each model type (Players, Mobiles, Items, etc.)
  - [ ] 1.4 Ensure seed data respects FK constraints and creates records in correct order
  - [ ] 1.5 Add seed data for NULL foreign keys and empty relationships
  - [ ] 1.6 Add `cleanup_seed_data()` function to teardown seed data
  - [ ] 1.7 Integrate seed data into test class setup/teardown
- [ ] 2.0 Generate Belongs-To Relationship Tests
  - [ ] 2.1 Add `generate_belongs_to_tests()` function to generate all belongs-to test methods
  - [ ] 2.2 Generate basic getter test: `test_belongs_to_<relation>_basic`
  - [ ] 2.3 Generate lazy loading test: `test_belongs_to_<relation>_lazy_load`
  - [ ] 2.4 Generate caching test: `test_belongs_to_<relation>_caching`
  - [ ] 2.5 Generate NULL foreign key test: `test_belongs_to_<relation>_null`
  - [ ] 2.6 Generate strict mode test: `test_belongs_to_<relation>_strict_mode`
  - [ ] 2.7 Generate setter test: `test_belongs_to_<relation>_setter`
  - [ ] 2.8 Generate setter marks dirty test: `test_belongs_to_<relation>_setter_marks_dirty`
- [ ] 3.0 Generate Has-Many Relationship Tests
  - [ ] 3.1 Add `generate_has_many_tests()` function to generate all has-many test methods
  - [ ] 3.2 Generate basic getter test: `test_has_many_<relation>_basic`
  - [ ] 3.3 Generate empty relationship test: `test_has_many_<relation>_empty`
  - [ ] 3.4 Generate lazy mode test: `test_has_many_<relation>_lazy`
  - [ ] 3.5 Generate eager mode test: `test_has_many_<relation>_eager`
  - [ ] 3.6 Generate caching test: `test_has_many_<relation>_caching`
  - [ ] 3.7 Generate reload test: `test_has_many_<relation>_reload`
  - [ ] 3.8 Generate unsaved parent test: `test_has_many_<relation>_unsaved_parent`
- [ ] 4.0 Generate Dirty Tracking Tests
  - [ ] 4.1 Add `generate_dirty_tracking_tests()` function to generate dirty tracking test methods
  - [ ] 4.2 Generate new model dirty test: `test_dirty_tracking_new_model`
  - [ ] 4.3 Generate saved model clean test: `test_dirty_tracking_saved_model`
  - [ ] 4.4 Generate setter marks dirty test: `test_dirty_tracking_setter`
  - [ ] 4.5 Generate save clears dirty test: `test_dirty_tracking_save_clears`
  - [ ] 4.6 Generate no-op save test: `test_dirty_tracking_skip_save`
- [ ] 5.0 Generate Cascade Save Tests
  - [ ] 5.1 Add `generate_cascade_save_tests()` function to generate cascade save test methods
  - [ ] 5.2 Generate belongs-to cascade test: `test_cascade_save_belongs_to`
  - [ ] 5.3 Generate has-many cascade test: `test_cascade_save_has_many`
  - [ ] 5.4 Generate deep cascade test: `test_cascade_save_deep`
  - [ ] 5.5 Generate transaction rollback test: `test_cascade_save_rollback`
  - [ ] 5.6 Generate cascade disabled test: `test_cascade_save_disabled`
  - [ ] 5.7 Generate skip clean models test: `test_cascade_save_skip_clean`
- [ ] 6.0 Generate Transaction Tests
  - [ ] 6.1 Add `generate_transaction_tests()` function to generate transaction test methods
  - [ ] 6.2 Generate transaction sharing test: `test_transaction_sharing`
  - [ ] 6.3 Generate transaction rollback test: `test_transaction_rollback`
  - [ ] 6.4 Generate nested save test: `test_nested_transaction_save`
- [ ] 7.0 Generate Edge Case Tests
  - [ ] 7.1 Add `generate_edge_case_tests()` function to generate edge case test methods
  - [ ] 7.2 Generate circular reference test: `test_circular_reference` (if applicable)
  - [ ] 7.3 Generate self-referential test: `test_self_referential` (for Mobile owned by Mobile)
  - [ ] 7.4 Generate multiple parents test: `test_multiple_parents`
  - [ ] 7.5 Generate pivot table test: `test_pivot_table_relationships` (for attribute_owners, inventory_owners)
- [ ] 8.0 Refactor Test Generation Architecture
  - [ ] 8.1 Modify `generate_tests()` function to detect relationships for each model
  - [ ] 8.2 Add relationship metadata to test generation context
  - [ ] 8.3 Organize tests into logical test classes (e.g., `TestPlayerRelationships`, `TestMobileRelationships`)
  - [ ] 8.4 Add class-level seed data setup using `setUpClass` and `tearDownClass`
  - [ ] 8.5 Ensure test methods have clear docstrings explaining what they validate
  - [ ] 8.6 Add helper functions for common test patterns (e.g., counting queries, checking cache)
- [ ] 9.0 Implement Test Utilities
  - [ ] 9.1 Add query counting utility to verify caching behavior
  - [ ] 9.2 Add mock/spy utilities for testing database operations
  - [ ] 9.3 Add assertion helpers for relationship testing (e.g., `assert_belongs_to`, `assert_has_many`)
  - [ ] 9.4 Add transaction testing utilities (connection sharing, rollback verification)
- [ ] 10.0 Run and Validate Generated Tests
  - [ ] 10.1 Generate all tests using enhanced `generate_models.py`
  - [ ] 10.2 Run `py tests.py` to execute all generated tests
  - [ ] 10.3 Verify all tests pass (100% pass rate expected)
  - [ ] 10.4 Validate test coverage includes all relationship features
  - [ ] 10.5 Check test performance (suite completes in < 30 seconds)
  - [ ] 10.6 Verify test isolation (tests can run in any order)
  - [ ] 10.7 Test failure scenarios by intentionally breaking code to verify tests catch bugs
- [ ] 11.0 Documentation and Cleanup
  - [ ] 11.1 Add comments to generated test code explaining test patterns
  - [ ] 11.2 Document seed data structure and usage
  - [ ] 11.3 Update PRD with actual implementation details and test counts
  - [ ] 11.4 Add examples of generated tests to PRD for reference
  - [ ] 11.5 Document any edge cases or limitations discovered during testing
